<?
include "{$_SERVER[DOCUMENT_ROOT]}/include/config.php";
include "./session_admin.php";
mysql_query("SET NAMES 'utf8'");

// 종료날짜 시작(현재기준 2일 전)
$firstDay = -2;
// 종료날짜 마지막(현재기준 7일 후)
$lastDay = 7;
// 종료날짜 쿼리 기간
$totalDay = 1 + $lastDay - $firstDay;
// 종료날짜(FinishDate)별 결제자 정보 배열
$tutoring = array();
for($i=0; $i<$totalDay; $i++){
    array_push($tutoring, array());
}

// 2일 전부터 7일 뒤까지, 총 10일 동안 튜터링이 종료되는 결제자 쿼리 && 배열에 담기
for($i=0; $i<$totalDay; $i++){
    $dateStr = date("Y-m-d", strtotime(($firstDay + $i)." day"));
    $sql = "SELECT T.*, M.KaKaoId, M.Hp FROM Tutoring T, MEMBER M
            WHERE 
                T.State='1'
                AND T.MemberId=M.MemberId
                AND DATE_FORMAT(T.FinishDate, '%Y-%m-%d') = DATE_FORMAT('$dateStr', '%Y-%m-%d')
            ;";
    $result = mysql_query($sql, $dbconn) or die(mysql_error());
    while($row = mysql_fetch_array($result)){
        array_push($tutoring[$i], $row);
    }
}

// SMS 전송확인 테이블 쿼리
$chkWeek = array();
$chkDate = array();
$sql = "SELECT * FROM sendSMS";
$result = mysql_query($sql, $dbconn) or die(mysql_error());
while($row = mysql_fetch_array($result)){
    $date = date("Y-m-d", strtotime($row[date_finstu]));
    array_push($chkWeek, $row[week]);
    array_push($chkDate, $date);
}
$chkSMS = array_combine($chkWeek, $chkDate);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Bootstrap Admin Theme</title>

    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- Timeline CSS -->
    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Morris Charts CSS -->

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">
        <? include "../common/include/nav.html"; ?>
        <!-- Navigation -->
        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">종료일</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-bordered table-condensed">
                        <tr>
                            <?
                                $week = array("일", "월", "화", "수", "목", "금", "토");
                                $color = array("red", "black", "black", "black", "black", "black", "blue");
                                $today = date("Y-m-d", strtotime("now"));
                                $cycle = 0;

                                for($i=0; $i<$totalDay; $i++){
                                    if($i == 7) $cycle++;
                                    $date = strtotime(($firstDay + $i)." day");
                                    $dateStr = date("Y-m-d", $date);
                                    //$dateStr = date("Y-m-d", $date)." (".$week[date("w", $date)].")";
                                    $weekNum = date("w",$date);
                            ?>
                            <td style="color:<?=$color[$weekNum]?>;"><?if($today == $dateStr){?><strong><?}?><?=$dateStr." (".$week[date("w", $date)].")"?><?if($today == $dateStr){?></strong><?}?>
                            <?if($cycle == 0 && $dateStr != $chkSMS[$weekNum]){?>
                                &nbsp;&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-xs btn-default" onclick="finstuSMS('<?=$weekNum?><?=$cycle?>', '<?=$dateStr?>')"><i class="fa fa-envelope-o" aria-hidden="true"></i></button>
                            <?}?>
                            </td>
                            <?  }?>
                        </tr>
                        <tr>
                            <?
                                $cycle = 0;
                                for($i=0; $i<$totalDay; $i++){
                                    if($i == 7) $cycle++;
                            ?>
                            <td>
                                <?
                                for($j=0; $j<count($tutoring[$i]); $j++){
                                    $date = strtotime(($firstDay + $i)." day");
                                ?>
                                <input type="hidden" class="id<?=date("w", $date)?><?=$cycle?>" value="<?=$tutoring[$i][$j][MemberId]?>" />
                                <input type="hidden" class="hp<?=date("w", $date)?><?=$cycle?>" value="<?=$tutoring[$i][$j][Hp]?>" />
                                <input type="hidden" class="ban<?=date("w", $date)?><?=$cycle?>" value="<?=$tutoring[$i][$j][Ban]?>" />
                                <input type="hidden" class="course<?=date("w", $date)?><?=$cycle?>" value="<?=$tutoring[$i][$j][Course]?>" />
                                <input type="hidden" class="name<?=date("w", $date)?><?=$cycle?>" value="<?=$tutoring[$i][$j][MemberName]?>" />
                                <a href="./stat0.html?idx=<?=$tutoring[$i][$j][idx]?>"><?=$tutoring[$i][$j][MemberName]?>(<?=$tutoring[$i][$j][KaKaoId]?>)</a><br />
                                <?  }?>
                            </td>
                            <?}?>
                        </tr>
                    </table>
                    <?
                        $url = $_SERVER[PHP_SELF];
                        $url_arr = explode("/", $url);
                        $url = $url_arr[count($url_arr) - 1];
                    ?>
                    <div style="text-align: right; color: gray;">마지막수정: <?=date("Ymd H:i:s",filemtime($url))?></div>
                </div>
            </div>
            <!-- /.row -->           
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>
    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>
    <script src="../js/js.js"></script>
</body>

</html>