<?php
include "{$_SERVER[DOCUMENT_ROOT]}/include/config.php";
include "./session_admin.php";

$mode = $_REQUEST['mode'];
if($mode=="delete"){
    $chk_idx=$_REQUEST['chk'];
    for($i=0; $i<count($chk_idx); $i++){
        $sql = 'update `LYDDIE2` set `State`=2 ';
        $sql.= 'where `idx`='.$chk_idx[$i].';';
        $result=mysql_query($sql, $dbconn);
        $sql = 'update `LYDDIE1` ';
        $sql.= 'set `RealNum`=(`RealNum`-1), ';
        $sql.= '`Rest`=CASE WHEN `Capa`>`RealNum` THEN (`Capa`-`RealNum`) ELSE 0 END, ';
        $sql.= '`Avail`=CASE WHEN `Rest`>0 THEN \'y\' ELSE \'n\' END ';
        $sql.= 'where `RegDate_f`=(select `RegDate_f` from `LYDDIE2` where `idx`='.$chk_idx[$i].') ';
        $sql.= 'and `Class`=(select `Class` from `LYDDIE2` where `idx`='.$chk_idx[$i].') ';
        $sql.= 'and `ApplyTime`=(select TIME_FORMAT((select `ApplyTime` from `LYDDIE2` ';
        $sql.= 'where `idx`='.$chk_idx[$i].'), \'%k:%i\')); ';
        $result=mysql_query($sql, $dbconn);
    }
}
?>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>SB Admin 2 - Bootstrap Admin Theme</title>
    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- Timeline CSS -->
    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Morris Charts CSS -->
    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <div id="wrapper">
        <? include "../common/include/nav.html"; ?>
        <!-- Navigation -->
        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">체험일순</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-3">
                    <form action="custom2.html?mode=student" method='get'>

                        <?
                $search_date = "";
                $class = $_GET["s_category"];
                if(!$_GET["search_date"]) $search_date = date_format(date_create(), "Y-m-d");
                else $search_date = $_GET["search_date"];
                        ?>
                        <div id="student_query" class="">
                            <input id="search_date" name="search_date" type="date" value="<?=$search_date?>" />
                            <select id="s_category" name="s_category">
                                <option value="">전체</option>
                                <option value="A" <? if($class == "A"){?> selected <? } ?>>1시간(A)</option>
                                <option value="B" <? if($class == "B"){?> selected <? } ?>>30분(B)</option>
                            </select>
                            <input type="submit" class="btn btn-default btn-sm" value="search" />
                        </div>
                    </form>
                </div>
                <div class="col-lg-3 col-lg-offset-6">
                    <form action="custom2.html" method='post'>
                        <input type="hidden" name="s_start_date" value="none" />
                        <div class="" style="text-align: right;">
                            <button type="button" class="btn btn-default btn-sm" onclick="openModal(-1)">체험자등록</button>
                            <input type="submit" class="btn btn-warning btn-sm" value="전체조회">
                        </div>
                    </form>
                </div>
                <div class="col-lg-12">
                    <form name="myform" action="custom2.html?mode=delete" method="post">
                        <div style="margin-top: 3px; margin-bottom: 3px;">
                            <input type="submit" class="btn btn-danger btn-xs" value="삭제">
                        </div>
                        <table class="table table-bordered table-condensed" style="font-size:0.9em;">                            
                            <thead>
                                <tr>
                                    <td><input type="checkbox" disabled></td>
                                    <th>번호</th>
                                    <th>이름</th>
                                    <th>카톡ID</th>
                                    <th>연락처</th>
                                    <th>체험일</th>
                                    <th>시간</th>
                                    <th>분류</th>
                                    <th>경로</th>
                                    <th>등록일</th>
                                    <th>예약문자</th>
                                    <th>카톡ID</th>
                                    <th>응대확인</th>
                                    <th>복사</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?
                    $show = 20;
                    $sql_date = "";
                    $sql_class = "";
                    if($search_date != "") $sql_date = "AND RegDate_f = date_format('$search_date', '%Y-%m-%d') ";
                    if($class=="A") $sql_class = "AND Class='A' ";
                    else if($class=="B") $sql_class = "AND Class='B' ";
                    // Get page_cnt
                    $sql = "SELECT * FROM LYDDIE2
                            WHERE State=1
                                $sql_date
                                $sql_class
                            ORDER BY
                                ApplyTime
                            ;";
                    $result = mysql_query($sql, $dbconn) or die(mysql_error());
                    $page_cnt = mysql_num_rows($result);
                    if($page_cnt%$show == 0){
                        $page_cnt = $page_cnt/$show;
                    } else{
                        $page_cnt = ($page_cnt-($page_cnt%$show))/$show + 1;
                    }
                    // Get pagenum
                    $pagenum = $_GET['pagenum'];
                    if($pagenum==""){
                        $pagenum = 1;
                    } else if($pagenum<=0){
                        $pagenum = 1;
                    } else if($pagenum>=$page_cnt){
                        $pagenum = $page_cnt;
                    }
                    // 한 페이지에서 보여줄 리스트번호의 최솟값과 최댓값
                    $min = 1 + ($pagenum - 1) * $show;
		                    $max = $min + ($show - 1);
                    // Get Tutoring_List
                    $sql = "SELECT a2.* FROM
                            (SELECT @rownum := @rownum + 1 AS rnum, a1.* FROM
                                (SELECT * FROM LYDDIE2
                                WHERE State=1
                                $sql_date
                                $sql_class
                                ORDER BY
                                    RegDate_f DESC
                                    ,ApplyTime ASC
                                    ,Class ASC
                                    ,idx DESC) a1
                                ,(SELECT @rownum := 0) TMP) a2
                            WHERE
                                a2.rnum >= $min
                                AND a2.rnum <= $max
                            ;";
                    $result=mysql_query($sql, $dbconn);
                    // 데이터베이스 데이터 출력 시작
                    $i = $show * ($pagenum - 1);
                    while($row=mysql_fetch_array($result))
                    {
                        $i++;
                        $sql2 = "SELECT COUNT(KakaoId) FROM LYDDIE2 WHERE KakaoId='$row[KakaoId]' AND State=1;";
                        $over = mysql_query($sql2, $dbconn);
                        $count = mysql_result($over, 0, 0);
                        if($count > 1){
                                ?>
                                <tr style='color:red'>
                                    <? } else{ ?>
                                <tr>
                                    <?}?>
                                    <td><input type="checkbox" name="chk[]" value="<?=$row[idx]?>"></td>
                                    <td><?=$i?></td>
                                    <td><?=$row[StuName]?></td>
                                    <td><a href="#" onclick="openModal(<?=$row[idx]?>, '<?=$row[StuName]?>', '<?=$row[KakaoId]?>', '<?=$row[PhoneNo]?>', '<?=$row[RegDate_f]?>', '<?=$row["Class"]?>', '<?=substr($row[ApplyTime], 0, -3)?>')"><?=$row[KakaoId]?></a></td>
                                    <td><?=$row[PhoneNo]?></td>
                                    <td><?=$row[RegDate_f]?></td>
                                    <td><?=substr($row[ApplyTime], 0, -3)?></td>
                                    <td><?=$row["Class"]?></td>
                                    <td><?=$row[Path]?></td>
                                    <td><?=date("Y-m-d", strtotime($row[Today]))?></td>
                                    <?if($row[SMS] == "N"){?>
                                    <td><button type="button" class="btn btn-sm" onclick="sendSMS('<?=$row[idx]?>', '<?=$row[StuName]?>', '<?=$row[PhoneNo]?>', '<?=substr($row[ApplyTime], 0, -3)?>', '<?=$row[RegDate_f]?>')"><i class="fa fa-envelope-o" aria-hidden="true"></i></button></td>
                                    <?} else {?>
                                    <td>발송완료</td>
                                    <?}?>
                                    <?if($row[SMS_kkd] == "N"){?>
                                    <td><button type="button" class="btn btn-sm" onclick="sendSMS_kkd('<?=$row[idx]?>', '<?=$row[StuName]?>', '<?=$row[PhoneNo]?>')"><i class="fa fa-envelope-o" aria-hidden="true"></i></button></td>
                                    <?} else {?>
                                    <td>발송완료</td>
                                    <?}?>
                                    <?if($row[Cal_chk] == "N"){?>
                                    <td><button type="button" class="btn btn-sm" onclick="cal_chk('<?=$row[idx]?>', 'cal')">확인</button></td>
                                    <?} else {?>
                                    <td>응대완료</td>
                                    <?}?>
                                    <td>Z0B_<?=$row[StuName]?>( <?=$row[KakaoId]?> )[+82-<?=$row[PhoneNo]?>]</td>
                                </tr>
                                <?}?>
                            </tbody>
                        </table>
                        <br />
                        <?include "./stu_info.html";?>
                        <!--pagination-->
                        <ul class="pagination">
                            <? if($pagenum<=1){     // pagenum가 1 이하?>
                            <li class="pagination_button disabled"><a href="">Previous</a></li>
                            <? } else{              // pagenum가 1 이하가 아닐 때?>
                            <li class="pagination_button"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$pagenum-1?>">Previous</a></li>
                            <? } ?>
                            <?
                    if($page_cnt <= 5){
                        for($i=1; $i<=$page_cnt; $i++){
                            ?>
                            <li class="pagination_button1"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$i?>"><?=$i?></a></li>
                            <?
      }
                    } else{
                            ?>
                            <li class="pagination_button1"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=1">1</a></li>

                            <?
                    if($pagenum<=4){     // pagenum가 4 이하일 때 5까지는 무조건 출력
                        for($i=2; $i<=5; $i++){
                            ?>
                            <li class="pagination_button<?=$i?>"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$i?>"><?=$i?></a></li>
                            <?  } ?>
                            <li class="pagination_button disabled"><a href="">...</a></li>
                            <?
                     } else if($pagenum>4 && $pagenum <= $page_cnt-4){                // pagenum 5부터 마지막 페이지의 4 전까지
                            ?>
                            <li class="disabled"><a href="">...</a></li>
                            <li class="pagination_button" id="pagination_button<?=$pagenum-1?>"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$pagenum-1?>"><?=$pagenum-1?></a></li>
                            <li class="pagination_button" id="pagination_button<?=$pagenum?>"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$pagenum?>"><?=$pagenum?></a></li>
                            <li class="pagination_button" id="pagination_button<?=$pagenum+1?>"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$pagenum+1?>"><?=$pagenum+1?></a></li>
                            <li class="disabled"><a href="">...</a></li>
                            <? } else{ ?>
                            <li class="pagination_button disabled"><a href="">...</a></li>
                            <?
                        for($i=$page_cnt-4; $i<$page_cnt; $i++){
                            ?>
                            <li class="pagination_button" id="pagination_button<?=$i?>"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$i?>"><?=$i?></a></li>
                            <?
      }
                    }
                            ?>
                            <li class="pagination_button" id="pagination_button<?=$page_cnt?>"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$page_cnt?>"><?=$page_cnt?></a></li>
                            <? } ?>
                            <? if($pagenum>=$page_cnt){ ?>
                            <li class="pagination_button disabled"><a href="">Next</a></li>
                            <? } else{ ?>
                            <li class="pagination_button"><a href="custom2.html?show=<?=$show?>&search_date=<?=$search_date?>&s_category=<?=$class?>&pagenum=<?=$pagenum+1?>">Next</a></li>
                            <? } ?>
                        </ul>
                    </form>
                </div>                 
                <?
                                $url = $_SERVER[PHP_SELF];
                                $url_arr = explode("/", $url);
                                $url = $url_arr[count($url_arr) - 1];
                ?>
                <div style="text-align: right; color: gray;">마지막수정: <?=date("Ymd H:i:s",filemtime($url))?></div>마지막수정: <?=date("Ymd H:i:s",filemtime("custom2.html"))?></div>
                <?
                // 데이터베이스와의 접속 종료
                mysql_close();
                ?>
            </div>
            <!-- /.row -->
        </div>
        <!-- /#page-wrapper -->
    </div>
    <!-- /#wrapper -->
    <!-- jQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>
    <script src="../js/js.js"></script>
    <script>


    </script>
</body>
</html>
