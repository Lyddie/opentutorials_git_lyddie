<?php
include "{$_SERVER[DOCUMENT_ROOT]}/include/config.php";
include "./session_admin.php";
mysql_query("SET NAMES 'utf8'");

$month = array();
$cnt = array();
$cnt1 = array();
$cnt2 = array();
$cnt4 = array();
$cntAfter = array();

// 날짜배열
// 1월부터 현재까지 날짜 차이 계산
// 시작날짜
$yearstr = 2016;
$monthstr = 1;
$nowyear = (int)date("Y");
$nowmonth = (int)date("m");
$diffnum = ($nowyear - $yearstr) * 12 + $nowmonth - $monthstr;
for($i=0; $i<=$diffnum; $i++){
    if($monthstr<10) array_push($month, $yearstr."-0".$monthstr);
    else array_push($month, $yearstr."-".$monthstr);
    // year/month ++
    $monthstr++;
    // month = 13 --> month = 1; year ++
    if($monthstr==13){
        $yearstr++;
        $monthstr = 1;
    }
}

// 종료자수
$sql = "select T1.findate, count(T1.MemberId) as cnt from (
            select MemberId, date_format(FinishDate, '%Y-%m') as findate from Tutoring
                where State=1
                and date_format(FinishDate, '%Y-%m')>='2016-01'
                and date_format(FinishDate, '%Y-%m')<=date_format(now(), '%Y-%m')
             group by MemberId, findate)T1
        group by T1.findate
        ;";
$result = mysql_query($sql, $dbconn) or die(mysql_error());
while($row=mysql_fetch_array($result)){
    $cnt[$row[findate]] = $row[cnt];
    //array_push($cnt, $row[fin]=>$row[cnt]);
}

// 1주 이내 재구매자
$sql = "select date_format(T5.FinishDate, '%Y-%m') as fin, count(T5.idx) as cnt from (
            select T1.idx, T1.MemberId, T1.FinishDate, T4.RegDate from  
            (
                 select T2.idx, T2.MemberId, T2.RegDate, T2.FinishDate from Tutoring T2
                     where T2.State=1
                         and date_format(T2.FinishDate, '%Y-%m')>='2016-01'
                         and date_format(T2.FinishDate, '%Y-%m')<=date_format(now(), '%Y-%m')
                 group by T2.MemberId, date_format(T2.FinishDate, '%Y-%m')
            ) T1 
            left join 
            (
                 select T3.idx, T3.MemberId, T3.RegDate, T3.FinishDate from Tutoring T3
                     where T3.State=1
                        and date_format(T3.FinishDate, '%Y-%m')>='2016-01'
            ) T4
            on
                 T1.MemberId=T4.MemberId
                 and T1.idx<>T4.idx
               where
                  date_format(T4.RegDate, '%Y-%m-%d')>date_format(T1.RegDate, '%Y-%m-%d')
            group by
                T1.MemberId, date_format(T1.FinishDate, '%Y-%m')
        ) T5
        where
            datediff(T5.RegDate, T5.FinishDate)<=7
        group by 
            date_format(T5.FinishDate, '%Y-%m')
        ;";
        
$result = mysql_query($sql, $dbconn) or die(mysql_error());
while($row=mysql_fetch_array($result)){
    $cnt1[$row[fin]] = $row[cnt];
    //array_push($cnt1, $row[cnt]);
}

// 2주 이내 재구매자
$sql = "select date_format(T5.FinishDate, '%Y-%m') as fin, count(T5.idx) as cnt from (
            select T1.idx, T1.MemberId, T1.FinishDate, T4.RegDate from  
            (
                 select T2.idx, T2.MemberId, T2.RegDate, T2.FinishDate from Tutoring T2
                     where T2.State=1
                         and date_format(T2.FinishDate, '%Y-%m')>='2016-01'
                         and date_format(T2.FinishDate, '%Y-%m')<=date_format(now(), '%Y-%m')
                 group by T2.MemberId, date_format(T2.FinishDate, '%Y-%m')
            ) T1 
            left join 
            (
                 select T3.idx, T3.MemberId, T3.RegDate, T3.FinishDate from Tutoring T3
                     where T3.State=1
                        and date_format(T3.FinishDate, '%Y-%m')>='2016-01'
            ) T4
            on
                 T1.MemberId=T4.MemberId
                 and T1.idx<>T4.idx
               where
                  date_format(T4.RegDate, '%Y-%m-%d')>date_format(T1.RegDate, '%Y-%m-%d')
            group by
                T1.MemberId, date_format(T1.FinishDate, '%Y-%m')
        ) T5
        where
            datediff(T5.RegDate, T5.FinishDate)>7
            and datediff(T5.RegDate, T5.FinishDate)<=14
        group by 
            date_format(T5.FinishDate, '%Y-%m')
        ;";
        
$result = mysql_query($sql, $dbconn) or die(mysql_error());
while($row=mysql_fetch_array($result)){
    $cnt2[$row[fin]] = $row[cnt];
    //array_push($cnt2, $row[cnt]);
}

// 4주 이내 재구매자
$sql = "select date_format(T5.FinishDate, '%Y-%m') as fin, count(T5.idx) as cnt from (
            select T1.idx, T1.MemberId, T1.FinishDate, T4.RegDate from  
            (
                 select T2.idx, T2.MemberId, T2.RegDate, T2.FinishDate from Tutoring T2
                     where T2.State=1
                         and date_format(T2.FinishDate, '%Y-%m')>='2016-01'
                         and date_format(T2.FinishDate, '%Y-%m')<=date_format(now(), '%Y-%m')
                 group by T2.MemberId, date_format(T2.FinishDate, '%Y-%m')
            ) T1 
            left join 
            (
                 select T3.idx, T3.MemberId, T3.RegDate, T3.FinishDate from Tutoring T3
                     where T3.State=1
                        and date_format(T3.FinishDate, '%Y-%m')>='2016-01'
            ) T4
            on
                 T1.MemberId=T4.MemberId
                 and T1.idx<>T4.idx
               where
                  date_format(T4.RegDate, '%Y-%m-%d')>date_format(T1.RegDate, '%Y-%m-%d')
            group by
                T1.MemberId, date_format(T1.FinishDate, '%Y-%m')
        ) T5
        where
            datediff(T5.RegDate, T5.FinishDate)>14
            and datediff(T5.RegDate, T5.FinishDate)<=28
        group by 
            date_format(T5.FinishDate, '%Y-%m')
        ;";
        
$result = mysql_query($sql, $dbconn) or die(mysql_error());
while($row=mysql_fetch_array($result)){
    $cnt4[$row[fin]] = $row[cnt];
    //array_push($cnt4, $row[cnt]);
}

// 이후 재구매자
$sql = "select date_format(T5.FinishDate, '%Y-%m') as fin, count(T5.idx) as cnt from (
            select T1.idx, T1.MemberId, T1.FinishDate, T4.RegDate from  
            (
                 select T2.idx, T2.MemberId, T2.RegDate, T2.FinishDate from Tutoring T2
                     where T2.State=1
                         and date_format(T2.FinishDate, '%Y-%m')>='2016-01'
                         and date_format(T2.FinishDate, '%Y-%m')<=date_format(now(), '%Y-%m')
                 group by T2.MemberId, date_format(T2.FinishDate, '%Y-%m')
            ) T1 
            left join 
            (
                 select T3.idx, T3.MemberId, T3.RegDate, T3.FinishDate from Tutoring T3
                     where T3.State=1
                        and date_format(T3.FinishDate, '%Y-%m')>='2016-01'
            ) T4
            on
                 T1.MemberId=T4.MemberId
                 and T1.idx<>T4.idx
               where
                  date_format(T4.RegDate, '%Y-%m-%d')>date_format(T1.RegDate, '%Y-%m-%d')
            group by
                T1.MemberId, date_format(T1.FinishDate, '%Y-%m')
        ) T5
        where
            datediff(T5.RegDate, T5.FinishDate)>28
        group by 
            date_format(T5.FinishDate, '%Y-%m')
        ;";
        
$result = mysql_query($sql, $dbconn) or die(mysql_error());
while($row=mysql_fetch_array($result)){
    $cntAfter[$row[fin]] = $row[cnt];
    //array_push($cntAfter, $row[cnt]);
}

                            for($i=0;$i<count($month);$i++){
                                if(!$cnt[$month[$i]]) $cnt[$month[$i]] = 0;
                                if(!$cnt1[$month[$i]]) $cnt1[$month[$i]] = 0;
                                if(!$cnt2[$month[$i]]) $cnt2[$month[$i]] = 0;
                                if(!$cnt4[$month[$i]]) $cnt4[$month[$i]] = 0;
                                if(!$cntAfter[$month[$i]]) $cntAfter[$month[$i]] = 0;
                            }

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>SB Admin 2 - Bootstrap Admin Theme</title>
    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- Timeline CSS -->
    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Morris Charts CSS -->
    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        h3 {
            text-align: left;
            text-decoration: underline;
        }

        table tr td {
            vertical-align: top;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <? include "../common/include/nav.html"; ?>
        <!-- Navigation -->
        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">종료일자별 재구매</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-6">
                    <table class="table table-bordered table-condensed">
                        <thead>
                            <tr>
                                <td></td>
                                <td>종료자</td>
                                <td colspan="2">전체</td>
                                <td colspan="2">1주 이내 구매자</td>
                                <td colspan="2">2주 이내 구매자</td>
                                <td colspan="2">4주 이내 구매자</td>
                                <td colspan="2">이후 구매자</td>
                            </tr>
                        </thead>
                        <tbody>
                            <?
                            
                            for($i=0;$i<count($month);$i++){
                                $total = $cnt1[$month[$i]] + $cnt2[$month[$i]] + $cnt4[$month[$i]] + $cntAfter[$month[$i]];
                            ?>
                            <tr>
                                <td><?=$month[$i]?></td>
                                <td><?=$cnt[$month[$i]]?></td>
                                <td><?=$total?></td>
                                <td>(<?=round(100*($cnt1[$month[$i]] + $cnt2[$month[$i]] + $cnt4[$month[$i]] + $cntAfter[$month[$i]])/$cnt[$month[$i]], 2)?>%)</td>
                                <td><?=$cnt1[$month[$i]]?></td>
                                <td>(<?=round(100*$cnt1[$month[$i]]/$total, 2)?>%)</td>
                                <td><?=$cnt2[$month[$i]]?></td>
                                <td>(<?=round(100*$cnt2[$month[$i]]/$total, 2)?>%)</td>
                                <td><?=$cnt4[$month[$i]]?></td>
                                <td>(<?=round(100*$cnt4[$month[$i]]/$total, 2)?>%)</td>
                                <td><?=$cntAfter[$month[$i]]?></td>
                                <td>(<?=round(100*$cntAfter[$month[$i]]/$total, 2)?>%)</td>
                            </tr>
                            <?}?>
                        </tbody>
                    </table>
                    <p style="color: #e26e22;">* 전체 비율: 종료자 대비<br />* 기간별 재구매자 비율: 전체 재구매자 대비 (예: 2016-01 1주일 이내 구매자 비율 100 * (5/9) = 55.56%)</p>
                    <?
                    // 데이터베이스와의 접속 종료
                    mysql_close();
                    $url = $_SERVER[PHP_SELF];
                    $url_arr = explode("/", $url);
                    $url = $url_arr[count($url_arr) - 1];
                    ?>
                    <div style="text-align: right; color: gray;">마지막수정: <?=date("Ymd H:i:s",filemtime($url))?></div>
                </div>
            </div>
        </div>
        <!-- /.row -->
    </div>
    <!-- /#page-wrapper -->
    </div>
    <!-- /#wrapper -->
    <!-- jQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>
</body>
</html>
