<?php
include "{$_SERVER[DOCUMENT_ROOT]}/include/config.php";
include "./session_admin.php";
// 중복쿼리
$sql = "select * from ";
// 중복자
$sql.= "(select count(*) as cnt_r, sum(A.totalTerm) as sum_r from (";
$sql.= "select MemberId, count(*) as cntTutoring, sum(cast(replace(Term, '개월', '') as signed)) as totalTerm from Tutoring where State=1 ";
$sql.= "group by MemberId having count(*)>1 ";
$sql.= ") A) A, ";
// 1회 이용자
$sql.= "(select count(*) as cnt_f, sum(B.totalTerm) as sum_f from (";
$sql.= "select MemberId, count(*) as cntTutoring, sum(cast(replace(Term, '개월', '') as signed)) as totalTerm from Tutoring where State=1 ";
$sql.= "group by MemberId having count(*)=1 ";
$sql.= ") B) B ";
$result = mysql_query($sql, $dbconn) or die(mysql_error());
$row = mysql_fetch_array($result);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Bootstrap Admin Theme</title>

    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- Timeline CSS -->
    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Morris Charts CSS -->

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        h3 {
            text-align: left;
            text-decoration: underline;
        }

        td {
            padding: 0;
        }

        input {
            margin: 0;
            border-style: hidden;
        }
    </style>
    <script>
        function dbupdate(){
            var f = document.myform;
            f.mode.value = "update";
            $("form[name='myform']").submit();

        }
    </script>
</head>
<body>
    <div id="wrapper">
        <? include "../common/include/nav.html"; ?>
        <!-- Navigation -->
        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">이용통계</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <form name="myform" method="post">
                        <table width="100%">
                            <colgroup>
                                <col width="50%" />
                                <col width="50%" />
                            </colgroup>
                            <tr>
                                <td>
                                    <div>
                                        <h3>평균이용기간</h3>
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>이용횟수</th>
                                                    <th>총이용자수</th>
                                                    <th>총이용기간</th>
                                                    <th>평균기간</th>
                                                </tr>
                                            </thead>
                                            <tbody>
  <?
                            echo "
                            <tr>
                            <td>1회</td>
                            <td>".$row[cnt_f]."</td>
                            <td>".$row[sum_f]."</td>
                            <td>".round($row[sum_f]/$row[cnt_f], 4)."</td>
                            </tr>
                            <tr>
                            <td>2회 이상</td>
                            <td>".$row[cnt_r]."</td>
                            <td>".$row[sum_r]."</td>
                            <td>".round($row[sum_r]/$row[cnt_r], 4)."</td>
                            </tr>
                            <tr>
                            <td>전체</td>
                            <td>".($row[cnt_r] + $row[cnt_f])."</td>
                            <td>".($row[sum_r] + $row[sum_f])."</td>
                            <td>".round(($row[sum_r] + $row[sum_f])/($row[cnt_r] + $row[cnt_f]), 4)."</td>
                            </tr>
                            ";
                                                ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="padding:10px;">
                                    <div class="">
  <?
                        // 3번 이상 결제한 구매자 select
                        $sql = "select MemberId, MemberName, count(MemberId) as cnt, sum(cast(replace(Term, '개월', '') as signed)) as term, ";
                        $sql.= "min(RegDate) as firstdate, max(RegDate) as lastdate ";
                        $sql.= "from Tutoring group by MemberId having count(*) >= 3 order by cnt desc;";
                        $result = mysql_query($sql, $dbconn);
                                        ?>
                                        <h3>3번 이상 구매자 리스트(<?=mysql_num_rows($result)?>)</h3>
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>No.</th>
                                                    <th>회원아이디</th>
                                                    <th>회원이름</th>
                                                    <th>구매횟수</th>
                                                    <th>이용기간</th>
                                                    <th>최초결제일</th>
                                                    <th>마지막결제일</th>
                                                </tr>
                                            </thead>
                                            <tbody>
  <?
                                $i = 1;
                                while($row = mysql_fetch_array($result)){
                                echo "
                                <tr>
                                <td>".$i++."</td>
                                <td>$row[MemberId]</td>
                                <td>$row[MemberName]</td>
                                <td>$row[cnt]</td>
                                <td>$row[term]</td>
                                <td>".date_format(date_create($row[firstdate]), 'Y-m-d')."</td>
                                <td>".date_format(date_create($row[lastdate]), 'Y-m-d')."</td>
                                </tr>
                                ";
                                }
                                                ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>

                                <td style="padding:10px;">
                                    <div>
  <?
                        // 결제기간이 6개월 이상인 구매자 select
                        $sql = "select MemberId, MemberName, count(MemberId) as cnt, sum(cast(replace(Term, '개월', '') as signed)) as term, ";
                        $sql.= "min(RegDate) as firstdate, max(RegDate) as lastdate ";
                        $sql.= "from Tutoring group by MemberId having sum(cast(replace(Term, '개월', '') as signed)) >= 6 order by term desc;";
                        $result = mysql_query($sql, $dbconn);
                                        ?>
                                        <h3>6개월 이상 구매자 리스트(<?=mysql_num_rows($result)?>)</h3>
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>No.</th>
                                                    <th>회원아이디</th>
                                                    <th>회원이름</th>
                                                    <th>구매횟수</th>
                                                    <th>이용기간</th>
                                                    <th>최초결제일</th>
                                                    <th>마지막결제일</th>
                                                </tr>
                                            </thead>
                                            <tbody>
  <?
                                $i = 1;
                                while($row = mysql_fetch_array($result)){
                                echo "
                                <tr>
                                <td>".$i++."</td>
                                <td>$row[MemberId]</td>
                                <td>$row[MemberName]</td>
                                <td>$row[cnt]</td>
                                <td>$row[term]</td>
                                <td>".date_format(date_create($row[firstdate]), 'Y-m-d')."</td>
                                <td>".date_format(date_create($row[lastdate]), 'Y-m-d')."</td>
                                </tr>
                                ";
                                }
                                                ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        </table>
  <?
        // 데이터베이스와의 접속 종료
        mysql_close();
                        ?>
                    </form>
                    <?
                            $url = $_SERVER[PHP_SELF];
                            $url_arr = explode("/", $url);
                            $url = $url_arr[count($url_arr) - 1];
                    ?>
                    <div style="text-align: right; color: gray;">마지막수정: <?=date("Ymd H:i:s",filemtime($url))?></div>
                </div>
                <!-- /.row -->
            </div>
            <!-- /#page-wrapper -->
        </div>
    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

    

    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>

</body>

</html>
