<?
include "{$_SERVER[DOCUMENT_ROOT]}/include/config.php";
include "./session_admin.php";

$tutor = array(array("david"), array("kristy"), array("kate"), array("ranalyn"), array("venice"));
$cutoffDate = array();
$sum = array();
$goal = array(25, 20, 15, 15, 10);
$date = strtotime("2016-06-12");
$lastDate = strtotime("last Sunday");
$lastDate = strtotime("+7 day", $lastDate);
while($date <= $lastDate){
    array_push($cutoffDate, $date);
    $date = strtotime("+7 day", $date);
    for($i=0; $i<count($tutor); $i++){
        array_push($tutor[$i], 0);
    }
}
$datestr = $cutoffDate[count($cutoffDate)-1];

for($i=0; $i<count($tutor); $i++){
    $sql = "SELECT Path_tll, DATE_FORMAT(Today, '%Y-%m-%d') AS today, COUNT(*) AS cnt FROM LYDDIE2  
              WHERE  
                Path_tll LIKE 'naver_%' 
                and Path_tll LIKE '%_".$tutor[$i][0]."' 
              GROUP BY 
                Path_tll, DATE_FORMAT(Today, '%Y-%m-%d') 
              ORDER BY today 
            ;";
    $result = mysql_query($sql, $dbconn) or die(mysql_error());
    $j = 1;
    while($row = mysql_fetch_array($result)){
        $date = strtotime($row[today]);
        if($date > $cutoffDate[$j]){
            $diff = $date - $cutoffDate[$j];
            $diff_date = (int)date("d", $diff);
            $j += 1 + (int)($diff_date / 7);
        }
        $tutor[$i][$j] += $row[cnt];
        $sum[$j] += $row[cnt];
    }
}

?>
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Bootstrap Admin Theme</title>

    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- Timeline CSS -->
    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Morris Charts CSS -->

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">
        <? include "../common/include/nav.html"; ?>
        <!-- Navigation -->
        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">튜터 관리</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th rowspan="2">날짜</th>
                                <th colspan="4">David</th>
                                <th colspan="4">Kristy</th>
                                <th colspan="4">Kate</th>
                                <th colspan="4">Ranalyn</th>
                                <th colspan="4">Venice</th>
                            </tr>
                            <tr>
                                <td>명수</td>
                                <td>전체 대비</td>
                                <td>전주 대비</td>
                                <td>목표 대비</td>
                                <td>명수</td>
                                <td>전체 대비</td>
                                <td>전주 대비</td>
                                <td>목표 대비</td>
                                <td>명수</td>
                                <td>전체 대비</td>
                                <td>전주 대비</td>
                                <td>목표 대비</td>
                                <td>명수</td>
                                <td>전체 대비</td>
                                <td>전주 대비</td>
                                <td>목표 대비</td>
                                <td>명수</td>
                                <td>전체 대비</td>
                                <td>전주 대비</td>
                                <td>목표 대비</td>
                            </tr>
                        </thead>
                        <tbody>
                            <?
                            for($i=count($cutoffDate)-1; $i>0; $i--){
                                echo "<tr>";
                                echo "<td>".date("Y-m-d", $cutoffDate[$i])."</td>";
                                for($j=0; $j<count($tutor); $j++){
                                    echo "<td>".$tutor[$j][$i]."</td>";
                                    if($sum[$i] != 0) echo "<td>".(100 * round($tutor[$j][$i]/$sum[$i], 4))."%</td>";
                                    else "<td>-</td>";
                                    if($tutor[$j][$i-1] != 0) echo "<td>".(100 * round($tutor[$j][$i]/$tutor[$j][$i-1], 4))."%</td>";
                                    else echo "<td>-</td>";
                                    if($goal[$j] != 0) echo "<td>".(100 * round($tutor[$j][$i]/$goal[$j], 4))."%</td>";
                                    else echo "<td>-</td>";
                                }
                                echo "</tr>";
                            }
                            ?>
                        </tbody>
                    </table>
                    <p>날짜 : 매 일요일마다 행 추가 선택되는 날은 따라서 그 전주 월요일부터 일요일까지</p>
                    <p>명수 : 선택된 날짜로부터 이전 7일동안 최초경로가 해당 튜터인 것을 카운팅(예: naver_1talk_kristy는 kristy)</p>
                    <p>전체대비 : 선택된 날짜로부터 이전 7일동안 모든 튜터의 명수 대비 %(해당 튜터의 수/전체 수)</p>
                    <p>전주대비 : 전 주(선택된 날짜로부터 14일 이전부터 8일전까지)의 명 수/이 주(선택된 날짜로부터 7일 이전부터 선택된 날짜까지)의 명수</p>
                    <p>목표대비 : 각 튜터별 목표를 설정하여 해당 목표대비 달성율 데이빗: 25, 크리스티: 20, 케이트: 15, 레널린: 15, 베니스: 10</p>
                </div>
               
            </div>
            <!-- /.row -->           
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

    

    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>

</body>

</html>
